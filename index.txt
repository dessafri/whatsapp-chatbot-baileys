const express = require("express");
const bodyParser = require("body-parser");
const fs = require("fs");
const path = require("path");
const axios = require("axios");
const cors = require('cors');
const config = require("./config.json");
const mysql2 = require("mysql2");
const Pusher = require('pusher');
const CryptoJS = require('crypto-js');

// Import Baileys
const { 
  default: makeWASocket, 
  DisconnectReason, 
  useMultiFileAuthState,
  fetchLatestBaileysVersion,
  makeCacheableSignalKeyStore,
  delay
} = require('@whiskeysockets/baileys');
const pino = require('pino');
const { Boom } = require('@hapi/boom');

function extractPhoneFromJid(jid) {
  if (!jid || typeof jid !== 'string') return null;
  if (jid.includes('status@broadcast') || jid.includes('broadcast')) return null;
  if (jid.endsWith('@g.us')) return null;

  if (jid.includes('@s.whatsapp.net') || jid.includes('@c.us')) {
    const num = jid.split('@')[0].split(':')[0];
    if (/^\d+$/.test(num) && num.length >= 8) return normalizePhone(num);
    return null;
  }

  if (jid.includes('@lid')) {
    const before = jid.split('@')[0];
    const possible = before.split(':')[0];
    if (/^\d+$/.test(possible) && possible.length >= 8) return normalizePhone(possible);
    return null;
  }

  const m = jid.match(/^(\d{8,})/);
  if (m) return normalizePhone(m[1]);

  return null;
}

function normalizePhone(raw) {
  if (!raw) return null;
  let num = String(raw).replace(/\D/g, '');
  if (num.startsWith('0')) num = '62' + num.slice(1);
  if (num.length >= 8 && num.length <= 15) return num;
  return null;
}

const pusher = new Pusher({
  appId: "1459540",
  key: "b3829b7fc55224f45b85",
  secret: "42252d7dfff06bae158b",
  cluster: "ap1",
  useTLS: true
});

var default_message_image_url = "./pertanyaan";
var default_message_image_url_brod = "./broadcast";

var default_message, connectionDb;
var chatbot_version = config.version_chatbot;

var connectionDb_local = {
  host: "localhost",
  user: "root",
  port: "3306",
  password: "",
  database: "chatbot-lasmini"
};

var connectionDb_server = {
  host: "localhost",
  user: "root",
  port: "3306",
  password: "J0mbang@74",
  database: "chatbot-lasmini"
};

// Gunakan local untuk development
connectionDb = connectionDb_local;

const HttpStatusCodes = Object.freeze({
  ER_TRUNCATED_WRONG_VALUE_FOR_FIELD: 422,
  ER_DUP_ENTRY: 409
});

var db = mysql2.createPool(connectionDb);

const queryNew = async (sql, values) => {
  return new Promise((resolve, reject) => {
    const callback = (error, result) => {
      if (error) {
        reject(error);
        return;
      }
      resolve(result);
    };
    db.query(sql, values, callback);
  }).catch((err) => {
    const mysqlErrorList = Object.keys(HttpStatusCodes);
    err.status = mysqlErrorList.includes(err.code) ?
      HttpStatusCodes[err.code] :
      err.status;
    throw err;
  });
};

process.title = "whatsapp-baileys-api";

// Global variables untuk Baileys
global.sock = null;
global.authed = false;

const app = express();
const port = process.env.PORT || config.port;

// Fungsi untuk normalisasi nomor WA - Support @lid
function normalizeNumber(id) {
  if (!id) return '';
  
  // Jika sudah format lengkap (@c.us, @s.whatsapp.net, @lid, @g.us)
  if (id.includes('@')) {
    return id;
  }
  
  // Hapus semua karakter non-digit
  let number = id.replace(/\D/g, '');
  
  // Jika nomor dimulai dengan 0, ganti dengan 62
  if (number.startsWith('0')) {
    number = '62' + number.substring(1);
  }
  
  // Return dengan @s.whatsapp.net (Baileys format)
  return number + '@s.whatsapp.net';
}

// Fungsi untuk validasi nomor WA
function isValidWhatsAppNumber(id) {
  if (!id) return false;
  
  // Cek apakah ini status broadcast
  if (id.includes('status@broadcast')) return false;
  
  // Cek apakah ini group
  if (id.includes('@g.us')) return true;
  
  // Cek apakah ini lid
  if (id.includes('@lid')) return true;
  
  // Untuk nomor personal
  const normalized = normalizeNumber(id);
  const number = normalized.replace('@s.whatsapp.net', '').replace('@c.us', '');
  
  // Validasi: nomor harus punya minimal 10 digit
  return number.length >= 10 && /^\d+$/.test(number);
}

app.use(bodyParser.json({ limit: "50mb" }));
app.use(cors());
app.use(express.json());
app.use(bodyParser.urlencoded({ extended: true }));

// Middleware global: normalisasi semua nomor WhatsApp
app.use((req, res, next) => {
  if (req.body && req.body.to) {
    req.body.to = normalizeNumber(req.body.to);
  }
  
  if (req.params && req.params.id) {
    req.params.id = normalizeNumber(req.params.id);
  }
  
  next();
});

// Fungsi untuk koneksi WhatsApp dengan Baileys
async function connectToWhatsApp() {
  const authFolder = './baileys_auth_info';
  
  // Buat folder auth jika belum ada
  if (!fs.existsSync(authFolder)) {
    fs.mkdirSync(authFolder, { recursive: true });
  }
  
  // Buat folder components jika belum ada
  if (!fs.existsSync('./components')) {
    fs.mkdirSync('./components', { recursive: true });
  }
  
  // Setup authentication state
  const { state, saveCreds } = await useMultiFileAuthState(authFolder);
  
  // Get latest Baileys version
  const { version, isLatest } = await fetchLatestBaileysVersion();
  console.log(`Using WA v${version.join('.')}, isLatest: ${isLatest}`);
  
  // Create socket connection
  global.sock = makeWASocket({
    version,
    logger: pino({ level: 'silent' }),
    printQRInTerminal: true,
    auth: {
      creds: state.creds,
      keys: makeCacheableSignalKeyStore(state.keys, pino({ level: 'silent' }))
    },
    generateHighQualityLinkPreview: true,
    browser: ['Baileys Chatbot', 'Chrome', '10.0'],
    // getMessage tidak lagi diperlukan tanpa store
  });
  
  // Connection update handler
  global.sock.ev.on('connection.update', async (update) => {
    const { connection, lastDisconnect, qr } = update;
    
    if (qr) {
      console.log('QR Code generated, scan it!');
      await queryNew(
        "UPDATE setting SET `value` = ? WHERE `key` = 'qr_code'",
        [qr]
      );
      fs.writeFileSync("./components/last.qr", qr);
    }
    
    if (connection === 'close') {
      const shouldReconnect = (lastDisconnect?.error instanceof Boom)
        ? lastDisconnect.error.output.statusCode !== DisconnectReason.loggedOut
        : true;
      
      console.log('Connection closed due to', lastDisconnect?.error, ', reconnecting:', shouldReconnect);
      
      await queryNew(
        "UPDATE setting SET `value` = 'false' WHERE `key` = 'status_connection_lustchatbot_app'"
      );
      await queryNew(
        "UPDATE setting SET `value` = 'disconnect' WHERE `key` = 'status_app'"
      );
      
      if (shouldReconnect) {
        setTimeout(() => connectToWhatsApp(), 3000);
      }
    } else if (connection === 'open') {
      console.log('Connected successfully!');
      global.authed = true;
      
      await queryNew(
        "UPDATE setting SET `value` = 'true' WHERE `key` = 'status_connection_app'"
      );
      await queryNew(
        "UPDATE setting SET `value` = 'true' WHERE `key` = 'status_connection_lustchatbot_app'"
      );
      await queryNew(
        "UPDATE setting SET `value` = 'connected' WHERE `key` = 'status_app'"
      );
      
      // Get phone number
      const phoneNumber = global.sock.user.id.split(':')[0];
      await queryNew(
        "UPDATE setting SET `value` = ? WHERE `key` = 'phone_number'",
        [phoneNumber]
      );
      
      try {
        fs.unlinkSync("./components/last.qr");
      } catch (err) {}
      
      // Start broadcast interval
      setInterval(async () => {
        await broadcast();
      }, 10000);
    }
  });
  
  // Credentials update handler
  global.sock.ev.on('creds.update', saveCreds);
  
  // Messages handler
  global.sock.ev.on('messages.upsert', async ({ messages, type }) => {
    if (type !== 'notify') return;
    
    for (const msg of messages) {
      if (!msg.message) continue;
      if (msg.key.fromMe) continue;
      
      try {
        // Extract message info
        const messageType = Object.keys(msg.message)[0];
        const messageContent = msg.message[messageType];
        
        // Create msg object compatible dengan kode lama
        const processedMsg = {
          from: msg.key.remoteJid,
          body: messageContent?.text || messageContent?.caption || messageContent?.conversation || '',
          hasMedia: ['imageMessage', 'videoMessage', 'audioMessage', 'documentMessage'].includes(messageType),
          message: msg.message,
          key: msg.key,
          messageType: messageType
        };
        
        // Validasi nomor
        if (!isValidWhatsAppNumber(processedMsg.from)) {
          console.log('Invalid WhatsApp number:', processedMsg.from);
          continue;
        }
        
        // Skip status broadcast
        if (processedMsg.from.includes('status@broadcast')) {
          continue;
        }
        
        console.log('Message from:', processedMsg.from, 'Body:', processedMsg.body);
        
        // Webhook
        if (config.webhook.enabled) {
          axios.post(config.webhook.path, { msg: processedMsg })
            .catch(err => console.error('Webhook error:', err));
        }
        
        await cekUserFirst(processedMsg);
        
        const res = await checkIsOperatorHandle(processedMsg);
        const operatorCommand = await checkIsOperatorCommand(processedMsg);
        
        if (!operatorCommand) {
          if (res) {
            await manageMessage(processedMsg);
          }
        }
      } catch (error) {
        console.error('Error handling message:', error);
      }
    }
  });
}

// Fungsi untuk kirim pesan (replace client.sendMessage)
async function sendMessage(jid, content, options = {}) {
  try {
    if (!global.sock) {
      throw new Error('WhatsApp not connected');
    }
    
    if (typeof content === 'string') {
      await global.sock.sendMessage(jid, { text: content }, options);
    } else {
      await global.sock.sendMessage(jid, content, options);
    }
    
    return { success: true };
  } catch (error) {
    console.error('Error sending message:', error);
    throw error;
  }
}

async function broadcast() {
  try {
    let queryListBroadcast = `SELECT b.*, p.nama, p.phone FROM broadcast b 
      JOIN broadcast_tujuan bt ON bt.broadcast_id = b.id 
      JOIN pelapor p ON bt.pelapor_id = p.id 
      WHERE b.start_date < ? AND b.status IS NULL`;
    
    var result = await queryNew(queryListBroadcast, [getdDateTime()]);
    
    if (result.length > 0) {
      for (var i = 0; i < result.length; i++) {
        var res = result[i];
        const normalizedPhone = normalizeNumber(res.phone);
        
        if (isValidWhatsAppNumber(normalizedPhone)) {
          try {
            await sendMessage(
              normalizedPhone,
              res.text.replace("[Nama]", res.nama)
            );
            
            await queryNew("UPDATE broadcast SET status='OK' WHERE id=?", [res.id]);
            await delay(1000); // Delay 1 detik antar pesan
          } catch (sendError) {
            console.error('Error sending broadcast to', normalizedPhone, ':', sendError);
            await queryNew("UPDATE broadcast SET status='ERROR' WHERE id=?", [res.id]);
          }
        }
      }
    }
  } catch (error) {
    console.error('Error in broadcast:', error);
  }
}

async function checkIsOperatorHandle(msgdata) {
  var phoneNumber = extractPhoneFromJid(msgdata.from);
  var result = await queryNew(
    "SELECT * FROM pelapor WHERE status = 'bot' AND phone=?",
    [phoneNumber]
  );
  return result.length > 0;
}

async function checkIsOperatorCommand(msgdata) {
  try {
    var rstMenuCommand = await queryNew(
      `SELECT * FROM pertanyaan WHERE code = ? OR nama = ? LIMIT 1`,
      [msgdata.body, msgdata.body]
    );
    
    if (rstMenuCommand.length > 0) {
      var operatorCommand = await queryNew(
        "SELECT * FROM setting WHERE `key` = 'operator_key'"
      );

      if (operatorCommand[0].value == rstMenuCommand[0].code) {
        await sendMessage(msgdata.from, rstMenuCommand[0].jawaban);
        
        await queryNew(
          `UPDATE pelapor SET status = 'operator', handle_status = 'belum' WHERE phone = ?`,
          [extractPhoneFromJid(msgdata.from)]
        );
        
        pusher.trigger("my-channel", "my-event", {
          message: "Anda Punya Permintaan Bantuan Operator! dari nomor whatsapp : " + extractPhoneFromJid(msgdata.from) + " Mohon Segera Cek",
          phoneNumber: extractPhoneFromJid(msgdata.from),
        });

        return true;
      }
    }
  } catch (error) {
    console.error('Error in checkIsOperatorCommand:', error);
  }
  return false;
}

async function manageMessage(msgdata) {
  try {
    console.log('Managing message from:', msgdata.from);
    
    const sanitizedBody = msgdata.body.replace(/'/g, "''");
    var rstMenuCommand = await queryNew(
      `SELECT * FROM pertanyaan WHERE code = ? OR nama = ? LIMIT 1`,
      [sanitizedBody, sanitizedBody]
    );
    
    if (rstMenuCommand.length > 0) {
      var message = rstMenuCommand[0].jawaban;
      let currentDate = new Date();
      let year = currentDate.getFullYear();
      let month = ('0' + (currentDate.getMonth() + 1)).slice(-2);
      let day = ('0' + currentDate.getDate()).slice(-2);
      let timestamp = year + '-' + month + '-' + day;
      
      if (message.includes("[linkPendaftaran]")) {
        await handleRegistrationLink(msgdata, message, timestamp, 
          "https://sianikv2.lasmini.com/kiosk-online?q=", 
          "Selamat datang di Unit Layanan Adminduk Disduk Capil, mohon bisa ditunggu sebentar..");
      } else if (message.includes("[linkPendaftaranMpp]")) {
        await handleRegistrationLink(msgdata, message, timestamp, 
          "https://mpp.lasmini.com/kiosk-online?q=", 
          "Selamat datang di Unit Layanan Adminduk MPP, mohon bisa ditunggu sebentar...");
      } else if (message.includes("[linkPendaftaranGondang]")) {
        await handleRegistrationLink(msgdata, message, timestamp, 
          "https://gondang.lasmini.com/kiosk-online?q=", 
          "Selamat datang di Unit Layanan Adminduk Kec. Gondang, mohon bisa ditunggu sebentar..");
      } else if (message.includes("[linkPendaftaranKertosono]")) {
        await handleRegistrationLink(msgdata, message, timestamp, 
          "https://kertosono.lasmini.com/kiosk-online?q=", 
          "Selamat datang di Unit Layanan Adminduk Kec. Kertosono, mohon bisa ditunggu sebentar..");
      } else if (message.includes("[linkPendaftaranBerbek]")) {
        await handleRegistrationLink(msgdata, message, timestamp, 
          "https://berbek.lasmini.com/kiosk-online?q=", 
          "Selamat datang di Unit Layanan Adminduk Kec. Berbek, mohon bisa ditunggu sebentar..");
      } else if (message.includes("[linkPendaftaranLengkong]")) {
        await handleRegistrationLink(msgdata, message, timestamp, 
          "https://lengkong.lasmini.com/kiosk-online?q=", 
          "Selamat datang di Unit Layanan Adminduk Kec. Lengkong, mohon bisa ditunggu sebentar..");
      } else if (message.includes("[linkPendaftaranTanjungAnom]")) {
        await handleRegistrationLink(msgdata, message, timestamp, 
          "https://tanjunganom.lasmini.com/kiosk-online?q=", 
          "Selamat datang di Unit Layanan Adminduk Kec. Tanjung Anom, mohon bisa ditunggu sebentar..");
      } else if (message.includes("[linkPendaftaranNganjuk]")) {
        await handleRegistrationLink(msgdata, message, timestamp, 
          "https://nganjuk.lasmini.com/kiosk-online?q=", 
          "Selamat datang di Unit Layanan Adminduk Kec. Pace, mohon bisa ditunggu sebentar..");
      } else if (message.includes("[linkPendaftaranPrambon]")) {
        await handleRegistrationLink(msgdata, message, timestamp, 
          "https://prambon.lasmini.com/kiosk-online?q=", 
          "Selamat datang di Unit Layanan Adminduk Kec. Prambon, mohon bisa ditunggu sebentar..");
      } else if (message.includes("[linkPendaftaranBagor]")) {
        await handleRegistrationLink(msgdata, message, timestamp, 
          "https://bagor.lasmini.com/kiosk-online?q=", 
          "Selamat datang di Unit Layanan Adminduk Kec. Bagor, mohon bisa ditunggu sebentar..");
      } else {
        await sendMessage(msgdata.from, message);
        await sendMenu(msgdata, rstMenuCommand[0]);
      }

    } else {
      var query_default_message = await queryNew(
        "SELECT * FROM setting WHERE `key` = ?",
        ["default_message"]
      );
      default_message = query_default_message[0].value;
      
      await sendMessage(msgdata.from, default_message);
      await sendMenu(msgdata);
    }
  } catch (error) {
    console.error('Error in manageMessage:', error);
  }
}

async function handleRegistrationLink(msgdata, message, timestamp, baseUrl, welcomeMsg) {
  try {
    const phoneNumber = extractPhoneFromJid(msgdata.from);
    const result = await queryNew("SELECT * FROM pelapor WHERE phone=?", [phoneNumber]);
    
    if (result.length > 0) {
      const postData = {
        id: result[0].id,
        phone: result[0].phone,
        date: timestamp,
      };

      const response = await axios.post('https://lasmini.com/api/encrypt', postData);
      
      await sendMessage(msgdata.from, welcomeMsg);

      setTimeout(async () => {
        const linkPlaceholder = message.match(/\[link[^\]]+\]/)[0];
        const finalMessage = message.replace(linkPlaceholder, baseUrl + response.data.data.token);
        await sendMessage(msgdata.from, finalMessage);
      }, 3000);
    }
  } catch (error) {
    console.error('Error in handleRegistrationLink:', error);
  }
}

function getdDateTime() {
  let date_ob = new Date();
  let date = ("0" + date_ob.getDate()).slice(-2);
  let month = ("0" + (date_ob.getMonth() + 1)).slice(-2);
  let year = date_ob.getFullYear();
  let hours = date_ob.getHours();
  let minutes = date_ob.getMinutes();
  let seconds = date_ob.getSeconds();

  return year + "-" + month + "-" + date + " " + hours + ":" + minutes + ":" + seconds;
}

async function sendImage(dataMessage, msgdata) {
  try {
    const imagePath = path.join(default_message_image_url, dataMessage.file);
    const imageBuffer = fs.readFileSync(imagePath);
    
    await sendMessage(msgdata.from, {
      image: imageBuffer,
      caption: dataMessage.jawaban
    });

    await sendMenu(msgdata, dataMessage);
  } catch (error) {
    console.error('Error in sendImage:', error);
  }
}

async function cekUserFirst(msgData) {
  try {
    const phoneNumber = extractPhoneFromJid(msgData.from);
    
    const existingUser = await queryNew(
      "SELECT * FROM pelapor WHERE phone=?",
      [phoneNumber]
    );
    
    if (existingUser.length === 0) {
      await queryNew(
        "INSERT INTO pelapor(phone) VALUES (?)",
        [phoneNumber]
      );
    }
    
    var getSystemNumber = await queryNew(
      "SELECT * FROM setting WHERE `key` = 'phone_number'"
    );

    var maskingWaGreeting = await queryNew(
      "SELECT * FROM masking_data WHERE `status` = 'aktif' AND wa_number = ?",
      [getSystemNumber[0].value]
    );

    if (maskingWaGreeting.length > 0) {
      var isGreeting = msgData.body.includes(maskingWaGreeting[0].template_text);

      if (isGreeting) {
        var messageData = msgData.body;
        if (messageData) {
          messageData = messageData.split(" - ");
          if (messageData && messageData.length > 1) {
            messageData = messageData[1].split("!");
            if (messageData && messageData.length > 1) {
              const messageDataName = messageData[0].split("-")[1];
              const messageDataNIK = messageData[1].split("-")[1];
              
              if (messageDataName && messageDataNIK) {
                await queryNew(
                  "UPDATE pelapor SET nama=?, nik=? WHERE phone=?",
                  [messageDataName, messageDataNIK, phoneNumber]
                );
                await sendMenu(msgData);
              }
            }
          }
        }
      }
    }
    
    await writeLog(msgData);
  } catch (error) {
    console.error('Error in cekUserFirst:', error);
  }
}

async function writeLog(msgData) {
  try {
    var phoneNumber = extractPhoneFromJid(msgData.from);
    var result = await queryNew(
      "SELECT * FROM pelapor WHERE phone=?",
      [phoneNumber]
    );
    
    if (result.length > 0) {
      await queryNew(
        "INSERT INTO log_user_chat(pelapor_id, pesan, tanggal) VALUES (?, ?, ?)",
        [result[0].id, msgData.body, getdDateTime()]
      );
    } else {
      await queryNew(
        "INSERT INTO pelapor(phone) VALUES (?)",
        [phoneNumber]
      );
    }
  } catch (error) {
    console.error('Error in writeLog:', error);
  }
}

async function writeLogSys(msgData, messageSys) {
  try {
    var phoneNumber = extractPhoneFromJid(msgData.from);
    var result = await queryNew(
      "SELECT * FROM pelapor WHERE phone=?",
      [phoneNumber]
    );
    
    if (result.length > 0) {
      await queryNew(
        "INSERT INTO log_user_chat(pelapor_id, pesan, tanggal, code) VALUES (?, ?, ?, 'Sys')",
        [result[0].id, messageSys, getdDateTime()]
      );
    } else {
      await queryNew(
        "INSERT INTO pelapor(phone) VALUES (?)",
        [phoneNumber]
      );

      var result2 = await queryNew(
        "SELECT * FROM pelapor WHERE phone=?",
        [phoneNumber]
      );

      await queryNew(
        "INSERT INTO log_user_chat(pelapor_id, pesan, tanggal, code) VALUES (?, ?, ?, 'Sys')",
        [result2[0].id, messageSys, getdDateTime()]
      );
    }
  } catch (error) {
    console.error('Error in writeLogSys:', error);
  }
}

async function sendMenu(msgData, dataMsg = false) {
  setTimeout(async () => {
    try {
      if (dataMsg) {
        var pid = dataMsg.id;
        var message = dataMsg.jawaban;
        
        if (chatbot_version == 1) {
          var listPertanyaanMaster = await queryNew(
            `SELECT * FROM pertanyaan WHERE pid = ? ORDER BY id ASC`,
            [pid]
          );

          if (listPertanyaanMaster.length > 0) {
            message = "Ketik nomor/kode/nama layanan informasi ADMINDUK :\n\n";
            listPertanyaanMaster.forEach((element, index) => {
              if (index + 1 == listPertanyaanMaster.length) {
                message += element.code + ". " + element.nama;
              } else {
                message += element.code + ". " + element.nama + " \n";
              }
            });   
          } else {
            var listPertanyaanMaster = await queryNew(
              "SELECT * FROM pertanyaan WHERE pid IS NULL ORDER BY id ASC"
            );
            message = "Ketik nomor/kode/nama layanan informasi ADMINDUK :\n\n";
            listPertanyaanMaster.forEach((element, index) => {
              if (index + 1 == listPertanyaanMaster.length) {
                message += element.code + ". " + element.nama;
              } else {
                message += element.code + ". " + element.nama + " \n";
              }
            });
          }
          await sendMessage(msgData.from, message);

        } else if (chatbot_version == 2) {
          // Baileys tidak support List seperti whatsapp-web.js
          // Jadi kita gunakan buttons atau text biasa
          var listPertanyaanMaster = await queryNew(
            `SELECT * FROM pertanyaan WHERE pid = ? ORDER BY id ASC`,
            [pid]
          );

          if (listPertanyaanMaster.length > 0) {
            message = "Ketik nomor/kode/nama layanan informasi ADMINDUK :\n\n";
            listPertanyaanMaster.forEach((element, index) => {
              if (index + 1 == listPertanyaanMaster.length) {
                message += element.code + ". " + element.nama;
              } else {
                message += element.code + ". " + element.nama + " \n";
              }
            });
          } else {
            var listPertanyaanMaster = await queryNew(
              "SELECT * FROM pertanyaan WHERE pid IS NULL ORDER BY id ASC"
            );
            message = "Ketik nomor/kode/nama layanan informasi ADMINDUK :\n\n";
            listPertanyaanMaster.forEach((element, index) => {
              if (index + 1 == listPertanyaanMaster.length) {
                message += element.code + ". " + element.nama;
              } else {
                message += element.code + ". " + element.nama + " \n";
              }
            });
          }

          await sendMessage(msgData.from, message);
        }

        await writeLogSys(msgData, message);
      } else {
        var message = "Ketik nomor/kode/nama layanan informasi ADMINDUK :\n\n";
        
        if (chatbot_version == 1) {
          var listPertanyaanMaster = await queryNew(
            `SELECT * FROM pertanyaan WHERE pid is null ORDER BY id ASC`
          );

          listPertanyaanMaster.forEach((element, index) => {
            if (index + 1 == listPertanyaanMaster.length) {
              message += element.code + ". " + element.nama;
            } else {
              message += element.code + ". " + element.nama + " \n";
            }
          });

          await sendMessage(msgData.from, message);
        }
      }
    } catch (error) {
      console.error('Error in sendMenu:', error);
    }
  }, 1000);
}

// Initialize WhatsApp connection
connectToWhatsApp();

// Routes
const chatRoute = require("./components/chatting");
const groupRoute = require("./components/group");
const authRoute = require("./components/auth");
const contactRoute = require("./components/contact");

app.use(function (req, res, next) {
  console.log(req.method + " : " + req.path);
  next();
});
// Tambahkan di bagian atas setelah require lainnya
const QRCode = require('qrcode');

// Tambahkan endpoint ini SEBELUM app.listen()

// Endpoint untuk tampilkan QR Code sebagai gambar
app.get('/qr', async (req, res) => {
  try {
    // Cek apakah sudah terkoneksi
    if (global.authed) {
      return res.send(`
        <html>
          <head>
            <title>WhatsApp Bot Status</title>
            <style>
              body {
                font-family: Arial, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              }
              .container {
                text-align: center;
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
              }
              h1 { color: #25D366; margin: 0 0 20px 0; }
              p { color: #666; font-size: 18px; }
              .status { color: #25D366; font-weight: bold; font-size: 24px; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>‚úÖ WhatsApp Bot Connected!</h1>
              <p class="status">Bot sudah aktif dan siap menerima pesan</p>
            </div>
          </body>
        </html>
      `);
    }

    // Baca QR dari database
    const qrData = await queryNew(
      "SELECT * FROM setting WHERE `key` = 'qr_code'"
    );

    if (!qrData || qrData.length === 0 || !qrData[0].value) {
      return res.send(`
        <html>
          <head>
            <title>WhatsApp Bot - Waiting</title>
            <style>
              body {
                font-family: Arial, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              }
              .container {
                text-align: center;
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
              }
              h1 { color: #ff6b6b; margin: 0 0 20px 0; }
              p { color: #666; font-size: 16px; }
            </style>
            <meta http-equiv="refresh" content="3">
          </head>
          <body>
            <div class="container">
              <h1>‚è≥ Menunggu QR Code...</h1>
              <p>QR Code belum ter-generate. Halaman akan refresh otomatis.</p>
              <p style="font-size: 14px; color: #999; margin-top: 20px;">
                Auto-refresh dalam 3 detik...
              </p>
            </div>
          </body>
        </html>
      `);
    }

    const qrText = qrData[0].value;

    // Generate QR Code sebagai data URL
    const qrImage = await QRCode.toDataURL(qrText, {
      width: 400,
      margin: 2,
      color: {
        dark: '#000000',
        light: '#ffffff'
      }
    });

    // Kirim HTML dengan QR Code
    res.send(`
      <html>
        <head>
          <title>Scan QR Code - WhatsApp Bot</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              display: flex;
              justify-content: center;
              align-items: center;
              min-height: 100vh;
              margin: 0;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .container {
              text-align: center;
              background: white;
              padding: 40px;
              border-radius: 20px;
              box-shadow: 0 10px 40px rgba(0,0,0,0.3);
              max-width: 500px;
            }
            h1 {
              color: #333;
              margin: 0 0 10px 0;
              font-size: 28px;
            }
            .subtitle {
              color: #666;
              margin: 0 0 30px 0;
              font-size: 16px;
            }
            .qr-container {
              background: white;
              padding: 20px;
              border-radius: 15px;
              display: inline-block;
              box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            }
            img {
              display: block;
              border-radius: 10px;
            }
            .instructions {
              margin-top: 30px;
              text-align: left;
              background: #f8f9fa;
              padding: 20px;
              border-radius: 10px;
            }
            .instructions h3 {
              margin: 0 0 15px 0;
              color: #333;
              font-size: 18px;
            }
            .instructions ol {
              margin: 0;
              padding-left: 20px;
            }
            .instructions li {
              margin: 10px 0;
              color: #555;
              line-height: 1.6;
            }
            .refresh-note {
              margin-top: 20px;
              padding: 15px;
              background: #e3f2fd;
              border-radius: 8px;
              color: #1976d2;
              font-size: 14px;
            }
          </style>
          <meta http-equiv="refresh" content="30">
        </head>
        <body>
          <div class="container">
            <h1>üì± Scan QR Code</h1>
            <p class="subtitle">Hubungkan WhatsApp Bot Anda</p>
            
            <div class="qr-container">
              <img src="${qrImage}" alt="QR Code" />
            </div>

            <div class="instructions">
              <h3>Cara Scan:</h3>
              <ol>
                <li>Buka <strong>WhatsApp</strong> di HP Anda</li>
                <li>Tap <strong>‚ãÆ</strong> (titik tiga) atau <strong>‚öôÔ∏è Settings</strong></li>
                <li>Pilih <strong>"Linked Devices"</strong> atau <strong>"Perangkat Tertaut"</strong></li>
                <li>Tap <strong>"Link a Device"</strong></li>
                <li><strong>Scan QR Code</strong> di atas</li>
              </ol>
            </div>

            <div class="refresh-note">
              ‚è±Ô∏è Halaman akan refresh otomatis setiap 30 detik
            </div>
          </div>
        </body>
      </html>
    `);
  } catch (error) {
    console.error('Error generating QR page:', error);
    res.status(500).send('Error generating QR code');
  }
});
app.use("/chat", chatRoute);
app.use("/group", groupRoute);
app.use("/auth", authRoute);
app.use("/contact", contactRoute);

app.listen(port, () => {
  console.log("Server Running Live on Port : " + port);
});